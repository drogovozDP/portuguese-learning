<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Word Trainer</title>
  <style>
    :root {
      --bg: #282a36;
      --bg-alt: #21222c;
      --fg: #f8f8f2;
      --comment: #6272a4;
      --cyan: #8be9fd;
      --green: #50fa7b;
      --pink: #ff79c6;
      --purple: #bd93f9;
      --red: #ff5555;
      --yellow: #f1fa8c;
      --border: #44475a;
    }

    body {
      font-family: system-ui, sans-serif;
      max-width: 700px;
      margin: 40px auto;
      background: var(--bg);
      color: var(--fg);
    }

    h2, h3 {
      color: var(--purple);
    }

    label {
      color: var(--comment);
    }

    select,
    input,
    button {
      font-size: 1em;
      padding: 8px;
      margin-top: 6px;
      background: var(--bg-alt);
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 6px;
      outline: none;
    }

    input {
      width: 100%;
    }

    select:focus,
    input:focus {
      border-color: var(--purple);
      box-shadow: 0 0 0 1px var(--purple);
    }

    button {
      cursor: pointer;
      background: linear-gradient(
        135deg,
        var(--purple),
        var(--pink)
      );
      color: #000;
      border: none;
      margin-top: 12px;
    }

    button:hover {
      opacity: 0.9;
    }

    hr {
      border: none;
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    #trainer {
      background: var(--bg-alt);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    #question_number {
      color: var(--comment);
      font-size: 0.9em;
    }

    #question {
      font-size: 1.4em;
      margin: 12px 0;
      color: var(--cyan);
    }

    .result {
      margin-top: 10px;
      font-weight: bold;
    }

    .result:contains("Correct") {
      color: var(--green);
    }

    .wrong {
      margin-top: 30px;
      background: var(--bg-alt);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    /* Hide summary if it does NOT contain a list of wrong answers */
    .wrong:not(:has(ul)) {
      display: none;
    }

    ul {
      padding-left: 20px;
    }

    li {
      margin-bottom: 6px;
    }

    li b {
      color: var(--yellow);
    }
  </style>
</head>
<body>

<h2>Portuguese Word Trainer</h2>

<label>
  Choose dictionary:
  <select id="dict"></select>
</label>

<button onclick="start()">Start training</button>

<hr>

<div id="trainer" style="display:none;">
  <div id="question_number"></div>
  <br>
  <div id="question"></div>
  <input
    id="answer"
    placeholder="Type translation..."
    onkeydown="handleKey(event)"
  />
  <button onclick="check()">Check</button>
  <div class="result" id="result"></div>
</div>

<div class="wrong" id="summary"></div>

<script>
  let pairs = [];
  let index = 0;
  let wrong = [];
  let current;

  async function loadDicts() {
    const res = await fetch("/api/dicts");
    const dicts = await res.json();
    const select = document.getElementById("dict");
    dicts.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      select.appendChild(opt);
    });
  }

  async function start() {
    const dict = document.getElementById("dict").value;
    const res = await fetch(`/api/session/start?dict_name=${dict}`, {
      method: "POST"
    });
    const data = await res.json();

    pairs = data.pairs;
    index = 0;
    wrong = [];

    document.getElementById("trainer").style.display = "block";
    document.getElementById("summary").innerHTML = "";

    next();
  }

  function next() {
    if (index >= pairs.length) {
      finish();
      return;
    }
    current = pairs[index];
    document.getElementById("question").innerText =
      current.ru[Math.floor(Math.random() * current.ru.length)];
    document.getElementById("question_number").innerText = `Question ${index + 1}/${pairs.length}`;
    document.getElementById("answer").value = "";
    document.getElementById("result").innerText = "";
  }

  async function check() {
    const answer = document.getElementById("answer").value;
    const ru = document.getElementById("question").innerText;

    const res = await fetch("/api/check", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        answer: answer,
        pt: current.pt,
        ru: ru
      })
    });

    const data = await res.json();

    if (!data.correct) {
      wrong.push({
        ru: data.ru,
        pt: data.pt,
        answer: answer
      });
    }

    document.getElementById("result").innerText =
      data.correct ? "‚úÖ Correct" : "‚ùå Incorrect";

    index++;
    setTimeout(next, 500);
  }

  function finish() {
    document.getElementById("trainer").style.display = "none";

    const summary = document.getElementById("summary");
    if (wrong.length === 0) {
      summary.innerHTML = "<h3>üéâ Perfect score!</h3>";
      return;
    }

    let html = `<h3>‚úÖ Correct: ${Math.floor(((pairs.length - wrong.length) / pairs.length) * 100)}%</h3><h3>‚ùå Incorrect answers</h3><ul>`;
    wrong.forEach(w => {
      html += `<li><b>${w.ru}</b> ‚Üí ${w.pt.join(", ")} ‚Äì (<b>${w.answer}</b>)</li>`;
    });
    html += "</ul>";
    summary.innerHTML = html;
  }

  loadDicts();
</script>

<script>
  function handleKey(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      check();
    }
  }
</script>

</body>
</html>
